@model LisBlanc.AdminPanel.Models.CreateAppointmentRequestViewModel

@{
    ViewData["Title"] = "Создание заявки";
}

<h1>Создание новой заявки</h1>

<h4>Заявка на запись</h4>
<hr />
<div class="row">
    <div class="col-md-4">
        <form asp-action="Create" id="createForm">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>

            <div class="form-group">
                <label asp-for="MasterId" class="control-label">Мастер</label>
                <select asp-for="MasterId" class="form-control" asp-items="ViewBag.MasterId" id="masterSelect">
                    <option value="">-- Выберите мастера --</option>
                </select>
                <span asp-validation-for="MasterId" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label asp-for="ServiceId" class="control-label">Услуга</label>
                <select asp-for="ServiceId" class="form-control" asp-items="ViewBag.ServiceId" id="serviceSelect">
                    <option value="">-- Выберите услугу --</option>
                </select>
                <span asp-validation-for="ServiceId" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label class="control-label">Желаемая дата</label>
                <input type="date" id="datePicker" class="form-control" min="@DateTime.Today.ToString("yyyy-MM-dd")" />
            </div>

            <div class="form-group">
                <label asp-for="SelectedDateTime" class="control-label">Доступное время</label>
                <select asp-for="SelectedDateTime" class="form-control" id="timeSelect">
                    <option value="">-- Сначала выберите мастера, услугу и дату --</option>
                </select>
                <span asp-validation-for="SelectedDateTime" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label asp-for="ClientName" class="control-label">Имя клиента</label>
                <input asp-for="ClientName" class="form-control" />
                <span asp-validation-for="ClientName" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label asp-for="ClientPhone" class="control-label">Телефон клиента</label>
                <input asp-for="ClientPhone" class="form-control" />
                <span asp-validation-for="ClientPhone" class="text-danger"></span>
            </div>

            <div class="form-group mt-3">
                <input type="submit" value="Создать" class="btn btn-primary" />
                <a asp-action="Index" class="btn btn-secondary">Назад к списку</a>
            </div>
        </form>
    </div>
</div>

<div id="loading" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Загрузка...</span>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        $(document).ready(function() {
            $('#masterSelect, #serviceSelect, #datePicker').change(function() {
                loadAvailableSlots();
            });

            function loadAvailableSlots() {
                var masterId = $('#masterSelect').val();
                var serviceId = $('#serviceSelect').val();
                var date = $('#datePicker').val();

                if (masterId && serviceId && date) {
                    $('#loading').show();
                    $('#timeSelect').prop('disabled', true);

                    // Отправляем дату в правильном формате (без преобразования в new Date)
                    $.get('/AppointmentRequests/GetAvailableSlots', {
                        masterId: masterId,
                        serviceId: serviceId,
                        date: date // Просто передаем строку в формате YYYY-MM-DD
                    }, function(data) {
                        $('#loading').hide();
                        $('#timeSelect').prop('disabled', false);

                        var timeSelect = $('#timeSelect');
                        timeSelect.empty();

                        if (data.length === 0) {
                            timeSelect.append($('<option>', {
                                value: '',
                                text: '-- Нет доступного времени --'
                            }));
                        } else {
                            timeSelect.append($('<option>', {
                                value: '',
                                text: '-- Выберите время --'
                            }));

                            $.each(data, function(index, slot) {
                                // slot.value уже приходит в формате "yyyy-MM-dd HH:mm:ss"
                                // Например: "2024-01-15 14:30:00"
                                timeSelect.append($('<option>', {
                                    value: slot.value,
                                    text: slot.time
                                }));
                            });
                        }
                    }).fail(function() {
                        $('#loading').hide();
                        $('#timeSelect').prop('disabled', false);
                        alert('Ошибка при загрузке доступного времени');
                    });
                }
            }

            // Валидация формы перед отправкой
            $('#createForm').submit(function(e) {
                if (!$('#timeSelect').val()) {
                    e.preventDefault();
                    alert('Пожалуйста, выберите время записи');
                    return false;
                }

                // Для отладки - посмотрим, какое значение отправляется
                console.log('SelectedDateTime value:', $('#timeSelect').val());
            });
        });
    </script>
}